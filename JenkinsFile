@Library('pipelib@master') _


node {
  def mvn = tool 'M3'
  def root = pwd()

  stage('Setup') {
    git([
      url: env.GIT_URL ? env.GIT_URL : 'https://github.com/venicegeo/dg-pz-servicecontroller',
      branch: "master"
    ])
  }

  stage('Archive') {
    sh """
      ${mvn}/bin/mvn clean package -U 
      cp target/pz-jobcommon-LATEST.jar ${root}/pz-jobcommon-LATEST.jar
      ${mvn}/bin/mvn clean package -U 
      cp target/piazzaServiceController-1.0.0.jar ${root}/pz-servicecontroller.jar
    """
  }

  stage('CI Deploy') {
    sh """
      cp target/piazzaServiceController-1.0.0.jar ${root}/pz-servicecontroller.jar
    """
    cfPush()
    cfBgDeploy()
  }

  stage('Integration Testing') {
    postman()
  }

  stage('Reset') {
    git([
      url: env.GIT_URL ? env.GIT_URL : 'https://github.com/venicegeo/dg-pz-servicecontroller',
      branch: "master"
    ])
  }

  stage('Staging Deploy') {
    cfPush {
      cfDomain  = 'coastline.dg-cf-test.net'
      cfSpace   = 'stage'
    }
    cfBgDeploy {
      cfDomain  = 'coastline.dg-cf-test.net'
      cfSpace   = 'stage'
    }
  }


  stage('Cleanup') {
    deleteDir()
  }
}
